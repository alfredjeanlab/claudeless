#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
#
# Policy enforcement for CI lints.
#
# Checks:
# 1. #[allow(...)] with forbidden lints only appear in test files
# 2. No new exceptions added to deny.toml (vs base branch)
# 3. No shellcheck disable comments in scripts
# 4. No new ignores in .cargo/audit.toml
# 5. No weakened lints in Cargo.toml (denyâ†’warn/allow)
#
# Usage: ./lint-policy [--base-branch main]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Default base branch for comparison
BASE_BRANCH="${1:-main}"
if [[ "$BASE_BRANCH" == "--base-branch" ]]; then
    BASE_BRANCH="${2:-main}"
fi


ERRORS=0

# =============================================================================
# Check 1: deny.toml policy
# =============================================================================
check_deny_toml() {
    local deny_file="$ROOT_DIR/deny.toml"
    [[ ! -f "$deny_file" ]] && return
    git -C "$ROOT_DIR" rev-parse --git-dir >/dev/null 2>&1 || return
    git -C "$ROOT_DIR" rev-parse "$BASE_BRANCH" >/dev/null 2>&1 || return

    local base_deny
    base_deny=$(git -C "$ROOT_DIR" show "$BASE_BRANCH:deny.toml" 2>/dev/null || echo "")
    [[ -z "$base_deny" ]] && return

    # Check license allow list
    local current_allows base_allows new_allows
    current_allows=$(grep -A 100 '^\[licenses\]' "$deny_file" | grep -A 50 '^allow = \[' | grep -E '^\s+"' | tr -d ' ",' | sort)
    base_allows=$(echo "$base_deny" | grep -A 100 '^\[licenses\]' | grep -A 50 '^allow = \[' | grep -E '^\s+"' | tr -d ' ",' | sort)
    new_allows=$(comm -23 <(echo "$current_allows") <(echo "$base_allows") || true)

    if [[ -n "$new_allows" ]]; then
        echo "ERROR: New license exceptions in deny.toml:"
        echo "$new_allows" | sed 's/^/  /'
        ERRORS=$((ERRORS + 1))
    fi

    # Check ban skip list
    local current_skips base_skips new_skips
    current_skips=$(grep -A 100 '^\[bans\]' "$deny_file" | grep -A 50 '^skip = \[' | grep 'crate = ' | sed 's/.*crate = "\([^"]*\)".*/\1/' | sort)
    base_skips=$(echo "$base_deny" | grep -A 100 '^\[bans\]' | grep -A 50 '^skip = \[' | grep 'crate = ' | sed 's/.*crate = "\([^"]*\)".*/\1/' | sort)
    new_skips=$(comm -23 <(echo "$current_skips") <(echo "$base_skips") || true)

    if [[ -n "$new_skips" ]]; then
        echo "ERROR: New skip exceptions in deny.toml [bans]:"
        echo "$new_skips" | sed 's/^/  /'
        ERRORS=$((ERRORS + 1))
    fi
}

# =============================================================================
# Check 2: cargo audit ignore policy
# =============================================================================
check_audit_toml() {
    local audit_file="$ROOT_DIR/.cargo/audit.toml"
    [[ ! -f "$audit_file" ]] && return
    git -C "$ROOT_DIR" rev-parse --git-dir >/dev/null 2>&1 || return
    git -C "$ROOT_DIR" rev-parse "$BASE_BRANCH" >/dev/null 2>&1 || return

    local base_audit
    base_audit=$(git -C "$ROOT_DIR" show "$BASE_BRANCH:.cargo/audit.toml" 2>/dev/null || echo "")
    [[ -z "$base_audit" ]] && return

    local current_ignores base_ignores new_ignores
    current_ignores=$(grep -E '^\s*"RUSTSEC-' "$audit_file" 2>/dev/null | tr -d ' ",' | sort || true)
    base_ignores=$(echo "$base_audit" | grep -E '^\s*"RUSTSEC-' 2>/dev/null | tr -d ' ",' | sort || true)
    new_ignores=$(comm -23 <(echo "$current_ignores") <(echo "$base_ignores") 2>/dev/null || true)

    if [[ -n "$new_ignores" ]]; then
        echo "ERROR: New advisory ignores in .cargo/audit.toml:"
        echo "$new_ignores" | sed 's/^/  /'
        ERRORS=$((ERRORS + 1))
    fi
}

# =============================================================================
# Main
# =============================================================================
check_deny_toml
check_audit_toml

if [[ $ERRORS -gt 0 ]]; then
    echo ""
    echo "=== FAILED: $ERRORS policy violation(s) ==="
    exit 1
fi
